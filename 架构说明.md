# Discord to WeChat Bridge - 架构说明

## 📐 系统架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                      discord_to_wechat.py                        │
│                          (主程序)                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │        DiscordToWechatBridge (桥接器)                   │   │
│  │  - 整合监听器和发送器                                     │   │
│  │  - 配置验证                                              │   │
│  │  - 消息路由                                              │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
           │                                    │
           │ 创建                                │ 创建
           ▼                                    ▼
┌──────────────────────────┐      ┌────────────────────────────┐
│   discord_listener.py    │      │    message_sender.py       │
│   (Discord监听器)         │      │    (发送器抽象基类)         │
│                          │      │                            │
│ ┌──────────────────────┐ │      │  ┌──────────────────────┐ │
│ │  DiscordListener     │ │      │  │  MessageSender       │ │
│ │  ----------------    │ │      │  │  -------------       │ │
│ │  + init_chrome()    │ │      │  │  + login()           │ │
│ │  + login_discord()  │ │      │  │  + send_message()    │ │
│ │  + monitor_messages()│ │      │  │  + keep_alive()      │ │
│ │  + extract_message()│ │      │  │  + cleanup()         │ │
│ └──────────────────────┘ │      │  └──────────────────────┘ │
│                          │      └────────────────────────────┘
│  使用 Selenium:          │                   │
│  - Chrome自动化          │                   │ 继承
│  - 多频道轮询            │       ┌───────────┴───────────┐
│  - 消息提取              │       │                       │
└──────────────────────────┘       ▼                       ▼
           │              ┌──────────────────┐  ┌──────────────────────┐
           │              │sender_wechat.py  │  │sender_enterprise     │
           │              │(微信个人号发送器) │  │_wechat.py           │
           │              │                  │  │(企业微信发送器)      │
           │              │ ┌──────────────┐ │  │ ┌──────────────────┐ │
           │              │ │WechatSender  │ │  │ │EnterpriseWechat  │ │
           │              │ │--------------│ │  │ │Sender            │ │
           │              │ │使用 itchat   │ │  │ │-----------------│ │
           │              │ │扫码登录      │ │  │ │使用 Webhook API │ │
           │              │ │个人聊天转发  │ │  │ │发送到企业微信群  │ │
           │              │ └──────────────┘ │  │ └──────────────────┘ │
           │              └──────────────────┘  └──────────────────────┘
           │                       │                       │
           └───────────────────────┴───────────────────────┘
                              │
                              ▼
                    ┌──────────────────┐
                    │   config.py      │
                    │   (配置文件)      │
                    │                  │
                    │ - SENDER_TYPE    │
                    │ - DISCORD_URLS   │
                    │ - WECHAT_CONFIG  │
                    │ - WEBHOOK_URL    │
                    └──────────────────┘
```

## 🔄 消息流程图

```
Discord频道
    │
    │ 1. Selenium自动化监听
    ▼
DiscordListener
    │ 提取消息信息
    │ {username, content, timestamp, attachments}
    │
    │ 2. 回调函数
    ▼
DiscordToWechatBridge
    │ 路由消息
    │
    │ 3. 调用发送器
    ▼
MessageSender
    │
    ├─────────────────┬─────────────────┐
    │                 │                 │
    ▼                 ▼                 ▼
WechatSender   EnterpriseWechatSender  ...更多发送器
    │                 │
    │ itchat发送      │ Webhook API
    ▼                 ▼
微信个人聊天      企业微信群
```

## 🎯 核心设计模式

### 1. 策略模式 (Strategy Pattern)
**目的**：让发送方式可以在运行时动态选择

```python
# message_sender.py - 抽象策略
class MessageSender(ABC):
    @abstractmethod
    def send_message(self, message_info, channel_name):
        pass

# sender_wechat.py - 具体策略A
class WechatSender(MessageSender):
    def send_message(self, message_info, channel_name):
        itchat.send(...)  # 微信实现

# sender_enterprise_wechat.py - 具体策略B
class EnterpriseWechatSender(MessageSender):
    def send_message(self, message_info, channel_name):
        requests.post(...)  # 企业微信实现

# discord_to_wechat.py - 上下文
bridge = DiscordToWechatBridge(sender_type="wechat")  # 动态选择
```

### 2. 观察者模式 (Observer Pattern)
**目的**：监听器发现新消息时通知发送器

```python
# discord_listener.py - 主题
class DiscordListener:
    def __init__(self, on_new_message):  # 注册观察者
        self.on_new_message = on_new_message
    
    def monitor_messages(self):
        # 发现新消息
        self.on_new_message(message_info, channel_name)  # 通知

# discord_to_wechat.py - 观察者
class DiscordToWechatBridge:
    def _on_new_message(self, message_info, channel_name):
        self.sender.send_message(...)  # 响应通知
```

### 3. 单一职责原则 (Single Responsibility)
每个模块只负责一件事：

- `discord_listener.py` - 只负责监听Discord
- `sender_wechat.py` - 只负责微信发送
- `sender_enterprise_wechat.py` - 只负责企业微信发送
- `message_sender.py` - 只定义接口规范
- `discord_to_wechat.py` - 只负责协调整合

### 4. 开闭原则 (Open-Closed Principle)
**对扩展开放，对修改关闭**

添加新发送方式时：
- ✅ 只需新建文件，继承 `MessageSender`
- ✅ 无需修改现有代码
- ✅ 在主程序中注册即可

示例 - 添加钉钉发送器：
```python
# 1. 创建 sender_dingtalk.py (新增)
class DingtalkSender(MessageSender):
    def send_message(...):
        # 钉钉实现
        pass

# 2. 在主程序中注册 (小改动)
def _create_sender(self, sender_type, ...):
    if sender_type == "dingtalk":  # 新增
        return DingtalkSender(...)
    # 其他代码不变
```

## 📦 模块依赖关系

```
discord_to_wechat.py (主程序)
    ├── config.py (配置)
    ├── discord_listener.py (监听器)
    │   └── selenium, webdriver_manager
    └── message_sender.py (抽象基类)
        ├── sender_wechat.py (微信发送器)
        │   └── itchat, threading
        └── sender_enterprise_wechat.py (企业微信发送器)
            └── requests
```

## 🔧 扩展点

### 1. 添加新的消息来源
当前只支持Discord，可以扩展：
- Telegram监听器
- Slack监听器
- IRC监听器

创建 `xxx_listener.py`，实现相同的回调接口即可。

### 2. 添加新的发送方式
当前支持微信和企业微信，可以扩展：
- 钉钉机器人
- 飞书机器人
- Telegram Bot
- 邮件发送

创建 `sender_xxx.py`，继承 `MessageSender` 即可。

### 3. 消息过滤和处理
可以在 `DiscordToWechatBridge._on_new_message` 中添加：
- 关键词过滤
- 用户黑/白名单
- 消息格式转换
- 内容审核

### 4. 消息持久化
可以在监听器中添加：
- 数据库存储
- 消息队列
- 日志归档

## 📊 性能考虑

### Discord监听
- **轮询间隔**：`CHECK_INTERVAL` 控制频率（默认3秒）
- **多频道支持**：顺序轮询，单线程模式
- **优化方向**：可改为多线程并发监听

### 消息发送
- **微信个人号**：无频率限制，但需保持在线
- **企业微信**：限制20条/分钟
- **优化方向**：可添加消息队列和限流

### 内存占用
- **Chrome**：~200-300MB（无头模式可降低）
- **Python**：~50-100MB
- **总计**：建议服务器至少1GB内存

## 🛡️ 错误处理

### 网络错误
- Discord连接失败：自动重试，刷新页面
- 发送失败：记录日志，跳过该消息

### 登录失效
- Discord：自动保存登录状态（`chrome_data/`）
- 微信：热登录机制（`itchat.pkl`）
- 企业微信：无需登录，Webhook永久有效

### 异常恢复
- 监听器错误：连续5次错误后刷新页面
- 发送器错误：记录日志，继续监听
- 程序崩溃：自动保存状态，重启后继续

## 📝 代码质量

### 日志系统
- 统一使用 `logging` 模块
- 同时输出到控制台和文件
- 分级记录（INFO/WARNING/ERROR）

### 类型提示
- 使用 Type Hints 增强可读性
- 明确函数参数和返回值类型

### 文档注释
- 每个类和方法都有 docstring
- 说明参数含义和返回值

### 模块化
- 高内聚：每个模块功能单一
- 低耦合：模块间依赖最小化
- 易测试：每个模块可独立测试

---

**设计理念**：简单、清晰、可扩展

