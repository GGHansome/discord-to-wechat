services:
  selenium:
    image: selenium/standalone-chrome:latest
    container_name: selenium
    shm_size: "2g"
    ports:
      - "7900:7900"  # noVNC 网页端口，可在浏览器内登录 Discord 以初始化资料
      - "4444:4444"  # Selenium WebDriver 端口（discord-to-wechat 通过它连接）
      # - "5900:5900"  # 如需原生 VNC 客户端
    # environment:
      # - SE_VNC_PASSWORD=mynewpassword  # 自定义 VNC 密码
    volumes:
      - ./selenium_data:/home/seluser/discord-chrome-data  # 使用命名卷持久化 WebDriver 的用户数据目录
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "/opt/bin/check-grid.sh", "--host", "0.0.0.0", "--port", "4444"]
      interval: 5s
      timeout: 10s
      retries: 10
      start_period: 30s
  discord-to-wechat:
    image: discord-to-wechat:latest
    build: .
    container_name: discord-to-wechat
    environment:
      # 可选：覆盖 config.py 中的参数（如需）
      - TZ=Asia/Shanghai
      # 在 docker compose 默认网络里，使用服务名访问 selenium
      - SELENIUM_REMOTE_URL=http://selenium:4444/wd/hub
      # 可选：为“程序自身的 HTTP 请求/下载”等设置代理（不影响 Chrome，Chrome 走下面的 CHROME_PROXY）
      # - HTTP_PROXY=http://127.0.0.1:7890
      # - HTTPS_PROXY=http://127.0.0.1:7890
      # 关键：避免 WebDriver 连接 selenium 也走代理
      # - NO_PROXY=selenium,localhost,127.0.0.1
      # 可选：显式设置 Chrome 代理（推荐用这个，确保 Selenium 里打开外网也走代理）
      # - CHROME_PROXY=http://127.0.0.1:7890
    volumes:
      - ./config.py:/app/config.py:ro
    depends_on:
      selenium:
        condition: service_healthy
    restart: unless-stopped

volumes:
  selenium_data:
    driver: local
