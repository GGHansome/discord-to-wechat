# Discord to WeChat/Enterprise WeChat Bridge - 使用说明

## 📋 项目结构

重构后的项目采用模块化设计，功能独立，便于维护和扩展：

```
discord_to_wechat/
├── discord_to_wechat.py          # 主程序入口，整合所有模块
├── config.py                      # 配置文件
├── discord_listener.py            # Discord消息监听器
├── message_sender.py              # 消息发送器抽象基类
├── sender_wechat.py              # 微信个人号发送器实现
├── sender_enterprise_wechat.py   # 企业微信机器人发送器实现
├── requirements.txt               # Python依赖
└── 使用说明.md                    # 本文件
```

## 🎯 核心模块说明

### 1. `message_sender.py` - 消息发送器抽象基类
定义了统一的消息发送接口，包括：
- `login()` - 登录/初始化
- `send_message()` - 发送消息
- `keep_alive()` - 保持连接
- `cleanup()` - 清理资源

所有发送器都继承此基类，确保接口一致性。

### 2. `sender_wechat.py` - 微信个人号发送器
使用 `itchat` 库实现微信个人号消息发送：
- 支持扫码登录（热登录，保存会话）
- 通过小号发送消息给大号
- 自动保持在线状态

### 3. `sender_enterprise_wechat.py` - 企业微信机器人发送器
使用企业微信 Webhook API 实现：
- 无需登录，使用 Webhook URL
- 支持发送到企业微信群
- 支持 Markdown 格式消息

### 4. `discord_listener.py` - Discord消息监听器
使用 Selenium 监听 Discord 频道：
- 支持多频道监听
- 自动保存登录状态
- 新消息通过回调函数处理

### 5. `discord_to_wechat.py` - 主程序
整合所有模块，提供统一入口：
- 根据配置选择发送器类型
- 协调监听器和发送器
- 配置验证和错误处理

## 🚀 快速开始

### 方式一：使用微信个人号

1. **配置 `config.py`**：
```python
# 选择发送方式
SENDER_TYPE = "wechat"

# Discord频道配置
DISCORD_CHANNEL_URLS = [
    "https://discord.com/channels/你的服务器ID/你的频道ID",
]

# 微信配置
WECHAT_RECEIVER_NAME = "你的大号备注名"
```

2. **运行程序**：
```bash
python discord_to_wechat.py
```

3. **扫码登录**：
   - 使用小号微信扫描控制台显示的二维码
   - 程序会自动查找大号并开始转发消息

### 方式二：使用企业微信机器人

1. **获取企业微信 Webhook**：
   - 在企业微信群中，点击 `群设置` -> `群机器人` -> `添加机器人`
   - 复制机器人的 Webhook 地址

2. **配置 `config.py`**：
```python
# 选择发送方式
SENDER_TYPE = "enterprise_wechat"

# Discord频道配置
DISCORD_CHANNEL_URLS = [
    "https://discord.com/channels/你的服务器ID/你的频道ID",
]

# 企业微信机器人配置
ENTERPRISE_WECHAT_WEBHOOK = "https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=你的key"
```

3. **运行程序**：
```bash
python discord_to_wechat.py
```

## ⚙️ 配置说明

### `SENDER_TYPE` - 发送方式
- `"wechat"` - 微信个人号（需要小号扫码）
- `"enterprise_wechat"` - 企业微信机器人（无需登录）

### `DISCORD_CHANNEL_URLS` - Discord频道列表
支持监听多个频道，格式：
```python
DISCORD_CHANNEL_URLS = [
    "https://discord.com/channels/服务器ID1/频道ID1",
    "https://discord.com/channels/服务器ID2/频道ID2",
]
```

### `CHECK_INTERVAL` - 检查间隔
监听频率，单位：秒。建议 3-5 秒。

### `HEADLESS_MODE` - 无头模式
- `False` - 显示浏览器窗口（推荐调试时使用）
- `True` - 后台运行，不显示窗口（推荐服务器部署）

## 🔄 两种发送方式对比

| 特性 | 微信个人号 | 企业微信机器人 |
|------|-----------|---------------|
| **登录方式** | 扫码登录 | 无需登录（Webhook） |
| **接收位置** | 个人聊天 | 企业微信群 |
| **消息格式** | 纯文本 | 支持 Markdown |
| **部署难度** | 需要小号保持在线 | 简单，无需维护会话 |
| **适用场景** | 个人使用 | 团队协作 |

## 🎨 扩展新的发送方式

如果需要添加其他发送方式（如钉钉、飞书等），只需：

1. **创建新的发送器类**（继承 `MessageSender`）：
```python
# sender_dingtalk.py
from message_sender import MessageSender

class DingtalkSender(MessageSender):
    def login(self):
        # 实现登录逻辑
        pass
    
    def send_message(self, message_info, channel_name):
        # 实现发送逻辑
        pass
    
    def keep_alive(self):
        pass
    
    def cleanup(self):
        pass
```

2. **在 `config.py` 中添加配置**：
```python
SENDER_TYPE = "dingtalk"
DINGTALK_WEBHOOK = "你的钉钉Webhook"
```

3. **在主程序中注册新发送器**：
```python
# discord_to_wechat.py 的 _create_sender 方法中
elif sender_type == "dingtalk":
    from sender_dingtalk import DingtalkSender
    return DingtalkSender(webhook_url=dingtalk_webhook)
```

## 🐛 调试技巧

### 查看详细日志
日志会同时输出到控制台和 `discord_bridge.log` 文件。

### Discord 登录问题
- 首次运行需要手动登录 Discord
- 登录状态保存在 `chrome_data` 目录
- 如遇登录问题，删除 `chrome_data` 目录重新登录

### 微信个人号问题
- 登录状态保存在 `itchat.pkl` 文件
- 如遇登录问题，删除该文件重新扫码
- 确保小号能找到大号（通过备注名或昵称）

### 企业微信机器人问题
- 检查 Webhook URL 是否正确
- 企业微信机器人有频率限制（20条/分钟）
- 测试时会发送初始化消息到群里

## 📝 常见问题

**Q: 可以同时使用两种发送方式吗？**  
A: 目前只支持单选。如需同时使用，可以运行两个程序实例，分别配置不同的 `SENDER_TYPE`。

**Q: 企业微信机器人支持发送图片吗？**  
A: 当前版本将图片链接以 Markdown 格式发送。可以在 `sender_enterprise_wechat.py` 中扩展图片上传功能。

**Q: Discord 监听会遗漏消息吗？**  
A: 程序会记录最后处理的消息ID，断线重连后会继续从该位置监听。首次运行只监听新消息。

**Q: 服务器部署需要注意什么？**  
A: 建议设置 `HEADLESS_MODE = True`，并确保安装了 Chrome 浏览器和 chromedriver。

## 📦 安装依赖

```bash
pip install -r requirements.txt
```

## 🎉 开始使用

```bash
# 编辑配置
vim config.py

# 运行程序
python discord_to_wechat.py
```

---

**提示**：如有问题或建议，欢迎提 Issue！


## 🐳 使用 Docker 部署

> 服务器无需预装 Python 与 Chrome，镜像内已包含运行所需环境（Python 3.11 + Google Chrome + 依赖）。

### 一键启动（推荐）

```bash
# 在项目根目录构建镜像并启动
docker compose up -d --build

# 查看日志
docker compose logs -f
```

- `chrome_data` 会挂载到宿主机，持久化保存 Discord 登录状态。
- `discord_bridge.log` 会挂载到宿主机，便于查看历史日志。
- `config.py` 以只读挂载到容器内部。修改宿主机 `config.py` 后重启容器生效。

### 首次登录 Discord
- 第一次启动需要在浏览器中完成 Discord 登录。
- 容器默认以无头模式运行。如需可视化登录，建议临时将 `config.py` 中 `HEADLESS_MODE = False`，并在本地运行测试；或使用远程桌面/带 X11 的高级方式。通常推荐：
  1) 在本地机器运行一次，登录后生成的 `chrome_data` 同步到服务器；
  2) 之后服务器使用同一份 `chrome_data` 无需再次登录。

### 自定义运行

```bash
# 直接使用 Dockerfile 构建
docker build -t discord-to-wechat:latest .

# 运行容器（无 compose）
docker run -d \
  --name discord-to-wechat \
  --shm-size=2g \
  -e TZ=Asia/Shanghai \
  -v $(pwd)/chrome_data:/app/chrome_data \
  -v $(pwd)/discord_bridge.log:/app/discord_bridge.log \
  -v $(pwd)/config.py:/app/config.py:ro \
  discord-to-wechat:latest
```

### 常见问题（Docker）
- Chrome 启动失败：已使用 `--no-sandbox`、`--disable-dev-shm-usage`，并将 `shm_size` 提升到 2G，通常可解决。若仍失败可尝试 `privileged: true`。
- 登录状态丢失：确认 `chrome_data` 挂载正确并具有写权限。
- 需要修改配置：直接修改宿主机 `config.py`，重启容器：`docker compose restart`。

